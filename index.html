<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembaca Kitab Wirid (Dilindungi)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        #viewer-container {
            width: 100%;
            max-width: 500px;
            margin: auto;
            background-color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        #canvas-wrapper {
            position: relative;
            width: 100%;
            overflow: hidden;
            background-color: #e9ebee;
        }
        #pdf-canvas {
            width: 200%; /* Kanvas 2x lebih lebar untuk menampilkan 2 halaman */
            max-width: 200%;
            display: block;
            transition: transform 0.3s ease-in-out;
        }
        /* --- Gaya untuk Mod Malam --- */
        .night-mode #viewer-container, .night-mode .bg-white {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .night-mode #canvas-wrapper {
             background-color: #121212;
        }
        .night-mode #pdf-canvas {
            filter: invert(1) hue-rotate(180deg);
        }
        .night-mode #page-counter, .night-mode svg {
             color: #a0aec0;
        }
        .night-mode #page-input {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .night-mode #version-info {
            color: #718096; /* Warna abu-abu yang lebih terang untuk mod malam */
        }
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #555;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 10;
        }
        .nav-button {
            background-color: #007bff;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-button:hover:not(:disabled) {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .nav-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        #page-input {
            -moz-appearance: textfield;
        }
        #page-input::-webkit-outer-spin-button,
        #page-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .error-container {
            text-align: center; 
            padding: 40px; 
            font-family: 'Inter', sans-serif; 
            color: #333;
            background-color: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
    <!-- Menggunakan versi pdf.js yang konsisten -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body class="flex flex-col min-h-screen justify-center items-center p-4">

    <div id="viewer-container" class="rounded-lg overflow-hidden">
        <!-- Tampilan Halaman Dokumen -->
        <div id="canvas-wrapper">
             <div id="loading-indicator">Memuat dokumen...</div>
             <canvas id="pdf-canvas"></canvas>
        </div>
        
        <!-- Navigasi -->
        <div class="bg-white p-4 border-t">
             <!-- Baris Atas Navigasi: Lompat Halaman dan Mod Malam -->
            <div class="flex justify-between items-center mb-4">
                 <!-- Go to Page Section -->
                <div class="flex">
                    <input type="number" id="page-input" placeholder="Ke halaman..." class="border rounded-l-md p-2 text-center w-32 focus:outline-none focus:ring-2 focus:ring-blue-500" min="0">
                    <button id="goto-button" class="bg-gray-700 text-white font-semibold px-4 py-2 rounded-r-md hover:bg-gray-800 transition-colors">Pergi</button>
                </div>
                <!-- Night Mode Toggle -->
                <button id="night-mode-toggle" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Mod Malam">
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
            </div>
             <!-- Main Navigation -->
            <div class="flex justify-between items-center">
                <button id="prev-button" class="nav-button">Sebelumnya</button>
                <div id="page-counter" class="text-gray-700 font-semibold text-center">
                    Halaman<br><span id="current-page">...</span> / <span id="total-pages">...</span>
                </div>
                <button id="next-button" class="nav-button">Berikutnya</button>
            </div>
            <!-- Version Info -->
            <div id="version-info" class="text-xs text-gray-400 text-center mt-3"></div>
        </div>
    </div>

    <script>
    // --- PERINGATAN ---
    // Kode di bawah ini adalah inti dari fungsionalitas aplikasi.
    // Mohon untuk tidak mengubahnya kecuali Anda memahami dampaknya.
    // Perubahan yang tidak disengaja dapat menyebabkan aplikasi berhenti bekerja.
    // ---
    
    try {
        // --- KONFIGURASI APLIKASI ---
        const pdfUrl = 'https://cdn.jsdelivr.net/gh/mohsyafiuddin69/kitab/KITAB_FULL.pdf';
        const appVersion = "by: Udua Digital"; // Versi aplikasi

        // --- Selektor Elemen ---
        const viewerContainer = document.getElementById('viewer-container');
        const nightModeToggle = document.getElementById('night-mode-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const loadingIndicator = document.getElementById('loading-indicator');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const pageCounter = {
            current: document.getElementById('current-page'),
            total: document.getElementById('total-pages')
        };
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageInput = document.getElementById('page-input');
        const gotoButton = document.getElementById('goto-button');
        const versionInfo = document.getElementById('version-info');

        // Atur teks versi
        if (versionInfo) {
            versionInfo.textContent = appVersion;
        }

        // --- Variabel Status ---
        let pdfDoc = null;
        let currentPdfPage = 1;
        let visibleSide = 'left';
        let isRendering = false;
        let totalLogicalPages = 0;

        // --- Fungsi Inti ---
        function renderPage(pdfPageNum) {
            if (!pdfDoc || isRendering) return;
            isRendering = true;
            loadingIndicator.style.display = 'block';

            pdfDoc.getPage(pdfPageNum).then(page => {
                const wrapperWidth = document.getElementById('canvas-wrapper').offsetWidth;
                const desiredWidth = wrapperWidth * 2;
                const viewport = page.getViewport({ scale: 1 });
                const scale = desiredWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                const renderContext = { canvasContext: ctx, viewport: scaledViewport };

                page.render(renderContext).promise.then(() => {
                    isRendering = false;
                    loadingIndicator.style.display = 'none';
                    updateView();
                }).catch(err => {
                    console.error("Gagal merender halaman: ", err);
                    isRendering = false;
                    loadingIndicator.style.display = 'none';
                });
            }).catch(err => {
                console.error(`Gagal mendapatkan halaman ${pdfPageNum}: `, err);
                isRendering = false;
                loadingIndicator.style.display = 'none';
            });
        }

        function updateView() {
            if (visibleSide === 'right') {
                canvas.style.transform = 'translateX(0)';
            } else {
                canvas.style.transform = 'translateX(-50%)';
            }
            updateUI();
        }

        function getCurrentLogicalPage() {
            const basePageNum = (currentPdfPage - 1) * 2;
            return (visibleSide === 'right') ? basePageNum + 1 : basePageNum;
        }

        function updateUI() {
            if (!pdfDoc) return;
            const logicalPageNum = getCurrentLogicalPage();
            pageCounter.current.textContent = logicalPageNum;
            pageCounter.total.textContent = totalLogicalPages - 1;
            nextButton.disabled = (logicalPageNum >= totalLogicalPages - 1);
            prevButton.disabled = (logicalPageNum <= 0);
            localStorage.setItem('lastLogicalPage', logicalPageNum);
        }

        // --- Fungsi Navigasi ---
        function goToNextPage() {
            if (isRendering || getCurrentLogicalPage() >= totalLogicalPages - 1) return;
            if (visibleSide === 'left') {
                visibleSide = 'right';
                updateView();
            } else {
                if (currentPdfPage < pdfDoc.numPages) {
                    currentPdfPage++;
                    visibleSide = 'left';
                    renderPage(currentPdfPage);
                }
            }
        }

        function goToPrevPage() {
            if (isRendering || getCurrentLogicalPage() <= 0) return;
            if (visibleSide === 'right') {
                visibleSide = 'left';
                updateView();
            } else {
                if (currentPdfPage > 1) {
                    currentPdfPage--;
                    visibleSide = 'right';
                    renderPage(currentPdfPage);
                }
            }
        }

        function goToLogicalPage(targetPage) {
            if (isNaN(targetPage) || targetPage < 0 || targetPage >= totalLogicalPages) {
                console.error(`Nomor halaman tidak valid: ${targetPage}`);
                return;
            }
            const newPdfPage = Math.floor(targetPage / 2) + 1;
            const newSide = (targetPage % 2 === 0) ? 'left' : 'right';
            if (newPdfPage !== currentPdfPage) {
                currentPdfPage = newPdfPage;
                visibleSide = newSide;
                renderPage(currentPdfPage);
            } else {
                visibleSide = newSide;
                updateView();
            }
        }

        function goToPageFromInput() {
            const targetPage = parseInt(pageInput.value, 10);
            if (!isNaN(targetPage)) {
                goToLogicalPage(targetPage);
            }
            pageInput.value = '';
            pageInput.blur();
        }

        // --- Inisialisasi dan Event Listeners ---
        function toggleNightMode() {
            document.body.classList.toggle('night-mode');
            const isNightMode = document.body.classList.contains('night-mode');
            localStorage.setItem('nightMode', isNightMode);
            moonIcon.classList.toggle('hidden', isNightMode);
            sunIcon.classList.toggle('hidden', !isNightMode);
        }

        function loadPdfFromUrl(url) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            pdfjsLib.getDocument(url).promise.then(doc => {
                pdfDoc = doc;
                totalLogicalPages = doc.numPages * 2;
                pageInput.setAttribute('max', totalLogicalPages - 1);
                let startLogicalPage = 0;
                const lastLogicalPage = parseInt(localStorage.getItem('lastLogicalPage'), 10);
                if (!isNaN(lastLogicalPage) && lastLogicalPage >= 0 && lastLogicalPage < totalLogicalPages) {
                    startLogicalPage = lastLogicalPage;
                }
                const initialPdfPage = Math.floor(startLogicalPage / 2) + 1;
                const initialSide = (startLogicalPage % 2 === 0) ? 'left' : 'right';
                currentPdfPage = initialPdfPage;
                visibleSide = initialSide;
                renderPage(currentPdfPage);
            }).catch(err => {
                console.error("Gagal memuat PDF: ", err);
                loadingIndicator.style.display = 'none';
                viewerContainer.innerHTML = `<p class="p-8 text-center text-red-600">Gagal memuat file PDF. Pastikan tautan benar dan dapat diakses.</p>`;
            });
        }

        // Menambahkan event listeners
        prevButton.addEventListener('click', goToPrevPage);
        nextButton.addEventListener('click', goToNextPage);
        gotoButton.addEventListener('click', goToPageFromInput);
        pageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') goToPageFromInput();
        });
        nightModeToggle.addEventListener('click', toggleNightMode);

        document.addEventListener('keydown', (event) => {
            if (document.activeElement === pageInput) return;
            if (event.key === 'ArrowRight') { event.preventDefault(); goToNextPage(); }
            if (event.key === 'ArrowLeft') { event.preventDefault(); goToPrevPage(); }
        });

        if (localStorage.getItem('nightMode') === 'true') {
            toggleNightMode();
        }

        loadPdfFromUrl(pdfUrl);

    } catch (error) {
        console.error("Terjadi kesalahan fatal pada aplikasi:", error);
        document.body.innerHTML = `
            <div class="error-container">
                <h1 class="text-2xl font-bold text-red-600 mb-4">Oops! Terjadi Kesalahan</h1>
                <p class="text-gray-700">Aplikasi pembaca kitab tidak dapat dimuat karena terjadi masalah.</p>
                <p class="text-gray-700">Silakan coba muat ulang halaman ini. Jika masalah berlanjut, hubungi pengelola file.</p>
                <p class="mt-6 text-sm text-gray-500">Detail error: ${error.message}</p>
            </div>
        `;
    }
    </script>
</body>
</html>

